import logging
from datetime import datetime, timedelta

from aiogram.dispatcher.filters import Text
from aiogram.types import Message, CallbackQuery, LabeledPrice, PreCheckoutQuery

import config
import keyboards.user as user_kb  # –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã –¥–ª—è –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (–≤—ã–±–æ—Ä –ø–æ–¥–ø–∏—Å–∫–∏, –æ–ø–ª–∞—Ç–∞)
import utils
from create_bot import dp  # –î–∏—Å–ø–µ—Ç—á–µ—Ä –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Ö–µ–Ω–¥–ª–µ—Ä–æ–≤
from utils import db, pay  # –ú–æ–¥—É–ª–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –∏ –ø–ª–∞—Ç–µ–∂–Ω—ã–º–∏ —Å–µ—Ä–≤–∏—Å–∞–º–∏

vary_types = {"subtle": "Subtle", "strong": "Strong"}  # –¢–∏–ø—ã –≤–∞—Ä–∏–∞—Ü–∏–π –¥–ª—è MidJourney

logger = logging.getLogger(__name__)

logging.basicConfig(
    level=logging.INFO,
    format='%(filename)s:%(lineno)d #%(levelname)-8s '
           '[%(asctime)s] - %(name)s - %(message)s')


# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫ –Ω–∞ –æ–ø–ª–∞—Ç—É –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
def get_pay_urls(order_id, amount):
    return {
        "tinkoff": pay.get_pay_url_tinkoff(order_id, amount),  # –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Tinkoff
        "freekassa": pay.get_pay_url_freekassa(order_id, amount),  # –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ FreeKassa
        "payok": pay.get_pay_url_payok(order_id, amount),  # –°—Å—ã–ª–∫–∞ –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ PayOK
    }


'''–ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤—ã–±–æ—Ä–∞ –ø–æ–∫—É–ø–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ - GPT –∏–ª–∏ MJ'''

# –ú–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ–∂–¥—É ChatGPT –∏ MidJourney
@dp.callback_query_handler(text="buy_sub") 
async def choose_neural_network(call: CallbackQuery):

    logger.info(f'–•—ç–Ω–¥–ª–µ—Ä {call.data}')
    
    await call.message.edit_text("""
–í—ã–±–µ—Ä–∏—Ç–µ –Ω–µ–π—Ä–æ—Å–µ—Ç—å‚§µÔ∏è""", 
    reply_markup=user_kb.get_neural_network_menu())


# –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –º–æ–¥–µ–ª–∏ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ ChatGPT
@dp.callback_query_handler(text="select_gpt_tokens")
async def choose_gpt_tokens(call: CallbackQuery):

    user_id = call.from_user.id
    
    await call.message.edit_text("""
–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å ChatGPT‚§µÔ∏è""", 
    reply_markup=user_kb.get_chatgpt_models())


# –ú–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ ChatGPT
@dp.callback_query_handler(Text(startswith="buy_chatgpt_tokens"))
async def choose_chatgpt_tokens(call: CallbackQuery):

    user_id = call.from_user.id
    model = call.data.split(":")[1]

    logger.info(f"User ID: {user_id}, –º–æ–¥–µ–ª—å ChatGPT: {model}")

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = await db.get_user_notified_gpt(user_id)
    now = datetime.now()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω–µ–µ 24 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
    if user_data and user_data['last_notification']:
        last_notification = user_data['last_notification']
        
        # –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—ã–ª–æ –º–µ–Ω–µ–µ 24 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–æ —Å–∫–∏–¥–∫–æ–π
        if now < last_notification + timedelta(hours=24):
            await call.message.edit_text(
                "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π‚§µÔ∏è",
                reply_markup=user_kb.get_chatgpt_tokens_menu('discount', model)
            )
    
    # –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –Ω–µ –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –∏–ª–∏ –ø—Ä–æ—à–ª–æ –±–æ–ª—å—à–µ 24 —á–∞—Å–æ–≤, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω–æ–µ –º–µ–Ω—é
    await call.message.edit_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤‚§µÔ∏è",
        reply_markup=user_kb.get_chatgpt_tokens_menu('normal', model)
    )


# –ú–µ–Ω—é –¥–ª—è –≤—ã–±–æ—Ä–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ MidJourney
@dp.callback_query_handler(text="buy_midjourney_requests")
async def choose_midjourney_requests(call: CallbackQuery):
    user_id = call.from_user.id
    
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    user_data = await db.get_user_notified_mj(user_id)
    now = datetime.now()

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –±—ã–ª–æ –ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –º–µ–Ω–µ–µ 24 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥
    if user_data and user_data['last_notification']:
        last_notification = user_data['last_notification']
        
        # –ï—Å–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—ã–ª–æ –º–µ–Ω–µ–µ 24 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–µ–Ω—é —Å–æ —Å–∫–∏–¥–∫–æ–π
        if now < last_notification + timedelta(hours=24):
            await call.message.edit_text(
                "–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ —Å–æ —Å–∫–∏–¥–∫–æ–π‚§µÔ∏è",
                reply_markup=user_kb.get_midjourney_discount_requests_menu()
            )
    
    await call.message.edit_text("""
–í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤‚§µÔ∏è""",
    reply_markup=user_kb.get_midjourney_requests_menu())


# –†–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è GPT
@dp.callback_query_handler(Text(startswith="tokens:"))
async def handle_chatgpt_tokens_purchase(call: CallbackQuery):

    user_id = call.from_user.id
    logger.info(f"User ID: {user_id} –≤—ã–±–∏—Ä–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ ChatGPT: {call.data}") 

    tokens = int(call.data.split(":")[1])  # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
    model = str(call.data.split(":")[2])  # –ü–æ–ª—É—á–∞–µ–º –º–æ–¥–µ–ª—å –°hatGPT
    amount = int(call.data.split(":")[3])  # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤
    src = str(call.data.split(":")[4])  # –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è - –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞

    logger.info(f"–†–∞–∑–æ–±—Ä–∞–Ω–Ω—ã–π callback: {tokens}, {model}, {amount}, {src}")
    
    discounts = {189, 315, 412, 628, 949, 1619, 2166, 3199, 227, 386, 509, 757}
    user_discount = await db.get_user_notified_gpt(user_id)

    if user_discount is None or (user_discount['used'] != True or (user_discount['used'] == True and amount not in discounts)):
        
        if amount in discounts:  # –ü–æ–∫—É–ø–∫–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π
            await db.update_used_discount_gpt(user_id)

        # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        order_id = await db.add_order(call.from_user.id, amount, model, tokens)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã
        urls = get_pay_urls('s'+str(order_id), amount)
    
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        await call.message.edit_text(f"‚úÖ{tokens / 1000} —Ç—ã—Å. —Ç–æ–∫–µ–Ω–æ–≤ –¥–ª—è GPT-{model}\nüí∞–°—É–º–º–∞: {amount}‚ÇΩ.",
                                     reply_markup=user_kb.get_pay_urls(urls, order_id, src))
    
    else:
        await call.message.edit_text("–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Å–∫–∏–¥–∫—É")

# –†–µ–∞–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–∞–∂–∞—Ç–∏–µ –∫–Ω–æ–ø–∫–∏ —Å –≤—ã–±–æ—Ä–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è Midjourney
@dp.callback_query_handler(Text(startswith="select_midjourney_requests:"))
async def handle_midjourney_requests_purchase(call: CallbackQuery):

    user_id = call.from_user.id
    requests_count = int(call.data.split(":")[1])  # –ü–æ–ª—É—á–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
    amount = int(call.data.split(":")[2])  # –ü–æ–ª—É—á–∞–µ–º —Ü–µ–Ω—É –∑–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤
    src = str(call.data.split(":")[3])  # –ò—Å—Ç–æ—á–Ω–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏—è - –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞
    discounts = [246, 550, 989]
    user_discount = await db.get_user_notified_mj(user_id)

    if user_discount is None or (user_discount['used'] != True or (user_discount['used'] == True and amount not in discounts)):
        
        if amount in discounts:  # –ü–æ–∫—É–ø–∫–∞ —Å–æ —Å–∫–∏–¥–∫–æ–π
            await db.update_used_discount_mj(user_id)
        
        # –°–æ–∑–¥–∞–µ–º –∑–∞–∫–∞–∑ –¥–ª—è –ø–æ–∫—É–ø–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
        order_id = await db.add_order(call.from_user.id, amount, "midjourney", requests_count)

        # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Å—ã–ª–∫–∏ –¥–ª—è –æ–ø–ª–∞—Ç—ã
        urls = get_pay_urls('s'+str(order_id), amount)

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –≤—ã–±–æ—Ä–æ–º —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã
        await call.message.edit_text(f"‚úÖ{requests_count} –∑–∞–ø—Ä–æ—Å–æ–≤ –¥–ª—è üé®MidJourney\nüí∞–°—É–º–º–∞: {amount}‚ÇΩ.",
                                     reply_markup=user_kb.get_pay_urls(urls, order_id, src))
    else:
        await call.message.edit_text("–í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —Å–∫–∏–¥–∫—É")


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Telegram (–ø—Ä–æ–ø–ª–∞—á–µ–Ω–Ω—ã–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª)
@dp.callback_query_handler(Text(startswith="tg_stars:"))
async def back_to_buy_vpn(call: CallbackQuery):

    order_id = int(call.data.split(":")[1])  # –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–∫–∞–∑–∞
    order = await db.get_order(order_id)  # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–∫–∞–∑–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω–≤–æ–π—Å –¥–ª—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Telegram
    await call.bot.send_invoice(call.from_user.id,
                                title="–ü—Ä–∏–æ–±—Ä–µ—Ç–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏",
                                description=f"""üí∞ –°—É–º–º–∞: {order['amount']} —Ä—É–±–ª–µ–π

‚ôªÔ∏è –°—Ä–µ–¥—Å—Ç–≤–∞ –∑–∞—á–∏—Å–ª—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏""",
                                provider_token="",  # –¢–æ–∫–µ–Ω –¥–ª—è –æ–ø–ª–∞—Ç—ã (–ø–ª–∞—Ç–µ–∂–Ω—ã–π –ø—Ä–æ–≤–∞–π–¥–µ—Ä)
                                payload=f"{order_id}",  # ID –∑–∞–∫–∞–∑–∞
                                currency="XTR",  # –í–∞–ª—é—Ç–∞ –æ–ø–ª–∞—Ç—ã
                                prices=[LabeledPrice(label="–ü–æ–¥–ø–∏—Å–∫–∞", amount=order["amount"] // 2)],  # –¶–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
                                reply_markup=user_kb.get_tg_stars_pay()  # –ö–Ω–æ–ø–∫–∞ –æ–ø–ª–∞—Ç—ã
                                )
    await call.answer()


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –æ–ø–ª–∞—Ç—ã —á–µ—Ä–µ–∑ Telegram
@dp.pre_checkout_query_handler()
async def approve_order(pre_checkout_query: PreCheckoutQuery):

    # –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º –∑–∞–∫–∞–∑ (–æ–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–∞)
    await pre_checkout_query.bot.answer_pre_checkout_query(pre_checkout_query.id, ok=True)


# –•–µ–Ω–¥–ª–µ—Ä –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
@dp.message_handler(content_types="successful_payment")
async def process_successful_payment(message: Message):
    
    order_id = int(message.successful_payment.invoice_payload)  # –ü–æ–ª—É—á–∞–µ–º ID –∑–∞–∫–∞–∑–∞ –∏–∑ payload
    await utils.pay.process_purchase(message.bot, order_id)  # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –ø–æ–¥–ø–∏—Å–∫—É (–æ–±–Ω–æ–≤–ª—è–µ–º –≤ –±–∞–∑–µ)


# –•—ç–Ω–¥–ª–¥–µ—Ä –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞ —Å—Å—ã–ª–∫–∏ –Ω–∞ –æ–ø–ª–∞—Ç—É Tinkoff:
@dp.callback_query_handler(Text(startswith="open_url"))
async def open_url(call: CallbackQuery):
    
    splitted = call.data.split(":")
    url = str(splitted[1] + ":" + splitted[2])

    await call.bot.send_message(call.from_user.id, f'–í–∞—à–∞ —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É:\n{url}\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –∏ –æ—Ç–∫—Ä–æ–π—Ç–µ –≤ —Å—Ç–æ—Ä–æ–Ω–Ω–µ–º –±—Ä–∞—É–∑–µ—Ä–µ\n\
–ù–µ –æ—Ç–∫—Ä—ã–≤–∞–π—Ç–µ —á–µ—Ä–µ–∑ Telegram-–±—Ä–∞—É–∑–µ—Ä')

    await call.answer()
